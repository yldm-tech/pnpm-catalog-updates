export const metadata = {
  title: 'Desarrollo',
  description:
    'Configura pnpm-catalog-updates para desarrollo. Aprende sobre la estructura del proyecto, flujo de trabajo de desarrollo y cÃ³mo contribuir.',
};

# Desarrollo

Configura PCU para desarrollo y aprende cÃ³mo contribuir al proyecto. Esta guÃ­a cubre configuraciÃ³n del proyecto, arquitectura y flujos de trabajo de desarrollo. {{ className: 'lead' }}

## Prerrequisitos

Antes de comenzar a desarrollar PCU, asegÃºrate de tener las herramientas requeridas:

<Note>Se requiere Node.js >= 22.0.0 y pnpm >= 10.0.0 para desarrollo.</Note>

<CodeGroup>

```bash {{ title: 'Verificar Versiones' }}
node --version  # DeberÃ­a ser >= 22.0.0
pnpm --version  # DeberÃ­a ser >= 10.0.0
```

```bash {{ title: 'Instalar Herramientas' }}
# Instalar Node.js via nvm (recomendado)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 22
nvm use 22

# Instalar pnpm
npm install -g pnpm@latest
```

</CodeGroup>

## ConfiguraciÃ³n del Proyecto

Clona y configura el entorno de desarrollo:

<CodeGroup>

```bash {{ title: 'Clonar y Configurar' }}
# Clonar el repositorio
git clone https://github.com/houko/pnpm-catalog-updates.git
cd pnpm-catalog-updates

# Instalar dependencias
pnpm install

# Construir el proyecto
pnpm build

# Ejecutar pruebas para verificar configuraciÃ³n
pnpm test
```

```bash {{ title: 'Modo de Desarrollo' }}
# Ejecutar en modo desarrollo
pnpm dev --help

# Construir en modo watch
pnpm build:watch

# Ejecutar pruebas en modo watch
pnpm test:watch
```

</CodeGroup>

## Arquitectura del Proyecto

PCU sigue principios de arquitectura limpia con clara separaciÃ³n de responsabilidades:

```text
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ cli/                    # Capa de aplicaciÃ³n CLI
â”‚   â”‚   â”œâ”€â”€ src/cli/           # Interfaz CLI
â”‚   â”‚   â”‚   â”œâ”€â”€ commands/      # Manejadores de comandos
â”‚   â”‚   â”‚   â”œâ”€â”€ formatters/    # Formateadores de salida
â”‚   â”‚   â”‚   â”œâ”€â”€ interactive/   # Prompts interactivos
â”‚   â”‚   â”‚   â”œâ”€â”€ themes/        # Temas de color
â”‚   â”‚   â”‚   â””â”€â”€ validators/    # ValidaciÃ³n de entrada
â”‚   â”‚   â””â”€â”€ bin/               # Binarios ejecutables
â”‚   â””â”€â”€ docs/                  # Sitio de documentaciÃ³n
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ core/                  # LÃ³gica de negocio principal
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ application/   # Servicios de aplicaciÃ³n
â”‚   â”‚       â”œâ”€â”€ domain/        # Modelo de dominio (DDD)
â”‚   â”‚       â””â”€â”€ infrastructure/# Capa de infraestructura
â”‚   â””â”€â”€ utils/                 # Utilidades compartidas
â””â”€â”€ scripts/                   # ConstrucciÃ³n y despliegue
```

### Capas de Arquitectura

<Properties>
  <Property name="Capa CLI" type="apps/cli">
    Interfaz de usuario, anÃ¡lisis de comandos, formateo de salida
  </Property>
  <Property name="Capa de AplicaciÃ³n" type="packages/core/application">
    OrquestaciÃ³n de lÃ³gica de negocio, casos de uso
  </Property>
  <Property name="Capa de Dominio" type="packages/core/domain">
    Entidades de negocio principales, objetos de valor, interfaces de repositorio
  </Property>
  <Property name="Capa de Infraestructura" type="packages/core/infrastructure">
    Clientes de API externa, acceso al sistema de archivos, implementaciones de repositorio
  </Property>
  <Property name="Capa de Utilidades" type="packages/utils">
    Utilidades compartidas, configuraciÃ³n, logging, manejo de errores
  </Property>
</Properties>

## Flujo de Trabajo de Desarrollo

### Realizar Cambios

1. **Crear una rama de caracterÃ­stica**:

   ```bash
   git checkout -b feature/amazing-feature
   ```

2. **Realizar cambios** siguiendo los estÃ¡ndares de codificaciÃ³n

3. **Agregar pruebas** para tus cambios:

   ```bash
   pnpm test:watch  # Ejecutar pruebas en modo watch
   ```

4. **Asegurar que las verificaciones de calidad pasen**:

   ```bash
   pnpm lint        # Verificar estilo de cÃ³digo
   pnpm typecheck   # VerificaciÃ³n de tipos
   pnpm test        # Ejecutar todas las pruebas
   ```

5. **Confirmar cambios**:
   ```bash
   git commit -m 'feat: add amazing feature'
   ```

### Estrategia de Pruebas

PCU usa un enfoque de pruebas integral:

<CodeGroup>

```bash {{ title: 'Pruebas Unitarias' }}
# Ejecutar pruebas unitarias
pnpm test

# Ejecutar con cobertura
pnpm test:coverage

# Probar paquete especÃ­fico
pnpm --filter @pcu/core test
```

```bash {{ title: 'Pruebas E2E' }}
# Ejecutar pruebas de extremo a extremo
pnpm test:e2e

# Probar contra proyectos reales
pnpm test:e2e --project example-workspace
```

```bash {{ title: 'Pruebas de IntegraciÃ³n' }}
# Probar comandos CLI
pnpm test:cli

# Probar con diferentes versiones de Node
nvm use 18 && pnpm test
nvm use 20 && pnpm test
nvm use 22 && pnpm test
```

</CodeGroup>

### Calidad de CÃ³digo

PCU mantiene altos estÃ¡ndares de calidad de cÃ³digo:

<CodeGroup>

```bash {{ title: 'Linting y Formateo' }}
# Verificar estilo de cÃ³digo
pnpm lint

# Corregir problemas de linting
pnpm lint:fix

# Formatear cÃ³digo
pnpm format

# Verificar tipos TypeScript
pnpm typecheck
```

```json {{ title: 'EstÃ¡ndares de Calidad' }}
{
  "coverage": {
    "statements": 85,
    "branches": 80,
    "functions": 85,
    "lines": 85
  },
  "lint": "ESLint con reglas TypeScript",
  "format": "Prettier con configuraciÃ³n personalizada",
  "types": "ConfiguraciÃ³n TypeScript estricta"
}
```

</CodeGroup>

## Agregar CaracterÃ­sticas

### Crear Nuevos Comandos

1. **Crear manejador de comando** en `apps/cli/src/cli/commands/`:

<CodeGroup>

```typescript {{ title: 'newCommand.ts' }}
import { Command } from 'commander';
import { GlobalOptions } from '../options';

export function createNewCommand(): Command {
  return new Command('new')
    .description('DescripciÃ³n del nuevo comando')
    .option('-f, --format <type>', 'Formato de salida', 'table')
    .action(async (options: NewCommandOptions) => {
      // ImplementaciÃ³n del comando
    });
}

interface NewCommandOptions extends GlobalOptions {
  format: string;
}
```

```typescript {{ title: 'Registrar Comando' }}
// En apps/cli/src/cli/index.ts
import { createNewCommand } from './commands/newCommand';

program.addCommand(createNewCommand());
```

</CodeGroup>

2. **Agregar lÃ³gica de negocio** en `packages/core/src/application/services/`

3. **Crear pruebas** para tanto CLI como lÃ³gica central

4. **Actualizar documentaciÃ³n**

### Agregar Nuevos Formatos de Salida

1. **Crear formateador** en `apps/cli/src/cli/formatters/`:

```typescript {{ title: 'xmlFormatter.ts' }}
import { OutputFormatter, FormattedOutput } from './outputFormatter';

export class XmlFormatter implements OutputFormatter {
  format(data: any): FormattedOutput {
    // LÃ³gica de formateo XML
    return {
      content: xmlContent,
      type: 'xml',
    };
  }
}
```

2. **Registrar formateador** en el registro principal de formateadores

3. **Agregar pruebas** y **actualizar documentaciÃ³n**

## GuÃ­as de ContribuciÃ³n

### ConvenciÃ³n de Mensajes de Commit

PCU usa [Conventional Commits](https://conventionalcommits.org/):

<CodeGroup>

```bash {{ title: 'Tipos de Commit' }}
feat: Una nueva caracterÃ­stica
fix: Una correcciÃ³n de bug
docs: Cambios solo de documentaciÃ³n
style: Cambios de estilo de cÃ³digo (formateo, etc)
refactor: Cambio de cÃ³digo que no corrige un bug ni agrega una caracterÃ­stica
test: Agregar pruebas faltantes o corregir pruebas existentes
chore: Cambios al proceso de construcciÃ³n o herramientas auxiliares
```

```bash {{ title: 'Ejemplos' }}
feat: add support for custom registries
fix: handle network timeouts gracefully
docs: update configuration examples
test: add tests for package filtering
```

</CodeGroup>

### Proceso de Pull Request

1. **Fork el repositorio** y crear una rama de caracterÃ­stica
2. **Realizar cambios** siguiendo el flujo de trabajo de desarrollo
3. **Asegurar que todas las pruebas pasen** y las verificaciones de calidad tengan Ã©xito
4. **Actualizar documentaciÃ³n** si es necesario
5. **Enviar un pull request** con:
   - DescripciÃ³n clara de los cambios
   - Enlace a issues relacionados
   - Capturas de pantalla para cambios de UI
   - Notas de cambios importantes si aplica

### Lista de VerificaciÃ³n de RevisiÃ³n de CÃ³digo

1. Todas las pruebas pasan
2. Cobertura de cÃ³digo mantenida (>85%)
3. Tipos TypeScript son correctos
4. Estilo de cÃ³digo sigue estÃ¡ndares del proyecto
5. DocumentaciÃ³n actualizada
6. Cambios importantes documentados
7. Impacto en el rendimiento considerado

## DepuraciÃ³n

### DepuraciÃ³n de Desarrollo

<CodeGroup>

```bash {{ title: 'Depurar Comandos CLI' }}
# Depurar con inspector Node.js
node --inspect-brk ./apps/cli/bin/pcu.js --help

# Depurar con VS Code
# Usar la configuraciÃ³n de lanzamiento en .vscode/launch.json
```

```bash {{ title: 'Logging Verboso' }}
# Habilitar logging de depuraciÃ³n
DEBUG=pcu:* pnpm dev --verbose

# Depurar mÃ³dulos especÃ­ficos
DEBUG=pcu:core,pcu:cli pcu -c
```

</CodeGroup>

### DepuraciÃ³n de Pruebas

```bash
# Depurar prueba especÃ­fica
npm test -- --grep "specific test name"

# Depurar con inspector Node
node --inspect-brk node_modules/.bin/vitest run
```

## ConstrucciÃ³n y PublicaciÃ³n

### Pruebas Locales

<CodeGroup>

```bash {{ title: 'Probar ConstrucciÃ³n Local' }}
# Construir y probar localmente
pnpm build
pnpm --filter @pcu/cli start --help

# Probar instalaciÃ³n
npm pack apps/cli
npm install -g pcu-*.tgz
```

```bash {{ title: 'Probar en Proyecto de Ejemplo' }}
# Usar el workspace de ejemplo
cd apps/example
pcu -c
pcu -u --dry-run
```

</CodeGroup>

### Proceso de Lanzamiento

1. **Actualizar versiÃ³n** usando changesets:

   ```bash
   pnpm changeset
   pnpm changeset version
   ```

2. **Construir y probar**:

   ```bash
   pnpm build
   pnpm test
   pnpm test:e2e
   ```

3. **Publicar** (solo mantenedores):
   ```bash
   pnpm publish -r
   ```

## Obtener Ayuda

- ğŸ“– **DocumentaciÃ³n**: Revisa esta documentaciÃ³n para guÃ­as detalladas
- ğŸ› **Issues**: Reporta bugs via [GitHub Issues](https://github.com/houko/pnpm-catalog-updates/issues)
- ğŸ’¬ **Discusiones**: Haz preguntas en [GitHub Discussions](https://github.com/houko/pnpm-catalog-updates/discussions)
- ğŸ”§ **Desarrollo**: Ãšnete a discusiones de desarrollo en issues y PRs

---

## Detalles Avanzados de Arquitectura

### Modelo de Dominio Central

Basado en principios de Domain-Driven Design (DDD), el dominio central de PCU incluye:

<CodeGroup>

```typescript {{ title: 'Entidades de Dominio' }}
// packages/core/src/domain/entities/
â”œâ”€â”€ catalog.ts          // RaÃ­z agregada de catÃ¡logo
â”œâ”€â”€ package.ts          // Entidad de paquete
â””â”€â”€ workspace.ts        // RaÃ­z agregada de workspace

// Conceptos clave de dominio:
interface Catalog {
  readonly id: CatalogId;
  readonly name: string;
  packages: PackageCollection;
  addPackage(packageInfo: Package): void;
  updatePackage(name: string, version: Version): void;
}

interface Package {
  readonly name: string;
  readonly currentVersion: Version;
  readonly latestVersion: Version;
  readonly updateType: UpdateType;
}
```

```typescript {{ title: 'Objetos de Valor' }}
// packages/core/src/domain/value-objects/
â”œâ”€â”€ version.ts           // Manejo de versiÃ³n semÃ¡ntica
â”œâ”€â”€ workspacePath.ts     // ValidaciÃ³n de ruta
â”œâ”€â”€ workspaceConfig.ts   // Objeto de configuraciÃ³n
â””â”€â”€ catalogCollection.ts // GestiÃ³n de colecciÃ³n

// Objetos de valor inmutables aseguran integridad de datos
class Version {
  constructor(private readonly value: string) {
    if (!this.isValid(value)) {
      throw new InvalidVersionError(value);
    }
  }

  toString(): string { return this.value; }
  compare(other: Version): number { /* comparaciÃ³n semver */ }
}
```

</CodeGroup>

### Arquitectura de Capa de Servicio

La capa de aplicaciÃ³n orquesta lÃ³gica de negocio a travÃ©s de servicios:

<CodeGroup>

```typescript {{ title: 'Servicios de AplicaciÃ³n' }}
// packages/core/src/application/services/
â”œâ”€â”€ catalogUpdateService.ts  // OrquestaciÃ³n principal
â””â”€â”€ workspaceService.ts      // Operaciones de workspace

// Responsabilidades de servicio:
class CatalogUpdateService {
  async checkForUpdates(options: CheckOptions): Promise<UpdateReport>;
  async updateCatalog(options: UpdateOptions): Promise<UpdateResult>;
  async analyzeImpact(catalog: string, package: string): Promise<ImpactAnalysis>;
}
```

```typescript {{ title: 'Capa de Infraestructura' }}
// packages/core/src/infrastructure/
â”œâ”€â”€ external-services/
â”‚   â””â”€â”€ npmRegistryService.ts   // Cliente API NPM
â”œâ”€â”€ repositories/
â”‚   â””â”€â”€ fileWorkspaceRepository.ts  // Persistencia del sistema de archivos
â”œâ”€â”€ cache/
â”‚   â””â”€â”€ cache.ts                # Sistema de cachÃ© avanzado
â””â”€â”€ utils/
    â””â”€â”€ npmrcParser.ts          # AnÃ¡lisis de configuraciÃ³n

// Infraestructura implementa interfaces de dominio:
class FileWorkspaceRepository implements WorkspaceRepository {
  async findWorkspace(path: string): Promise<Workspace | null>;
  async saveWorkspace(workspace: Workspace): Promise<void>;
}
```

</CodeGroup>

### DiseÃ±o de Capa CLI

La capa CLI proporciona una interfaz limpia al dominio central:

<CodeGroup>

```typescript {{ title: 'Estructura de Comando' }}
// apps/cli/src/cli/commands/
â”œâ”€â”€ checkCommand.ts     // ImplementaciÃ³n de comando de verificaciÃ³n
â”œâ”€â”€ updateCommand.ts    // Comando de actualizaciÃ³n con validaciÃ³n
â”œâ”€â”€ analyzeCommand.ts   // Comando de anÃ¡lisis de impacto
â”œâ”€â”€ workspaceCommand.ts # GestiÃ³n de workspace
â”œâ”€â”€ themeCommand.ts     # ConfiguraciÃ³n de tema
â”œâ”€â”€ securityCommand.ts  # Escaneo de seguridad
â””â”€â”€ initCommand.ts      # InicializaciÃ³n de workspace

// Cada comando sigue patrones consistentes:
export class CheckCommand {
  constructor(
    private readonly catalogService: CatalogUpdateService,
    private readonly validator: CommandValidator,
    private readonly formatter: OutputFormatter
  ) {}

  async execute(options: CheckCommandOptions): Promise<void> {
    const validation = this.validator.validateCheckOptions(options);
    if (!validation.isValid) {
      throw new ValidationError(validation.errors);
    }

    const result = await this.catalogService.checkForUpdates(options);
    const formatted = this.formatter.format(result, options.format);
    console.log(formatted);
  }
}
```

```typescript {{ title: 'CaracterÃ­sticas CLI Avanzadas' }}
// apps/cli/src/cli/
â”œâ”€â”€ validators/
â”‚   â””â”€â”€ commandValidator.ts    # ValidaciÃ³n de entrada con sugerencias
â”œâ”€â”€ interactive/
â”‚   â””â”€â”€ interactivePrompts.ts  # Prompts inteligentes con auto-completado
â”œâ”€â”€ themes/
â”‚   â””â”€â”€ colorTheme.ts          # Sistema de temas integral
â””â”€â”€ formatters/
    â””â”€â”€ outputFormatter.ts     # MÃºltiples formatos de salida

// CaracterÃ­sticas interactivas:
class InteractivePrompts {
  async selectPackages(packages: Package[]): Promise<string[]>;
  async confirmUpdates(updates: Update[]): Promise<boolean>;
  async configurationWizard(): Promise<Configuration>;
}
```

</CodeGroup>

### Arquitectura de Pruebas

Estrategia de pruebas integral a travÃ©s de todas las capas:

<CodeGroup>

```bash {{ title: 'Estructura de Pruebas' }}
â”œâ”€â”€ packages/core/src/**/__tests__/     # Pruebas unitarias
â”œâ”€â”€ packages/utils/src/**/__tests__/    # Pruebas de utilidades
â”œâ”€â”€ apps/cli/src/**/__tests__/         # Pruebas unitarias CLI
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ e2e/                          # Pruebas de extremo a extremo
â”‚   â”œâ”€â”€ integration/                  # Pruebas de integraciÃ³n
â”‚   â””â”€â”€ fixtures/                     # Fixtures de prueba
â””â”€â”€ .github/workflows/
    â””â”€â”€ test.yml                      # Pipeline de pruebas CI
```

```typescript {{ title: 'Patrones de Prueba' }}
// Pruebas de capa de dominio
describe('Catalog', () => {
  it('should update package version', () => {
    const catalog = new Catalog('default');
    const package = new Package('react', '18.0.0', '18.2.0');

    catalog.addPackage(package);
    catalog.updatePackage('react', new Version('18.2.0'));

    expect(catalog.getPackage('react').currentVersion.toString()).toBe('18.2.0');
  });
});

// Pruebas de integraciÃ³n CLI
describe('CheckCommand', () => {
  it('should handle network errors gracefully', async () => {
    const mockService = createMockCatalogService();
    mockService.checkForUpdates.mockRejectedValue(new NetworkError());

    const command = new CheckCommand(mockService);

    await expect(command.execute({})).rejects.toThrow('Network error occurred');
  });
});
```

</CodeGroup>

### Consideraciones de Rendimiento

PCU estÃ¡ optimizado para rendimiento en monorepos grandes:

<CodeGroup>

```typescript {{ title: 'Estrategia de CachÃ©' }}
// CachÃ© inteligente reduce llamadas API
class Cache<T> {
  constructor(
    private readonly options: {
      ttl: number; // Tiempo de vida
      maxSize: number; // LÃ­mite de memoria
      persistToDisk: boolean; // CachÃ© de archivo
      strategy: 'lru' | 'fifo' | 'lfu'; // Estrategia de expulsiÃ³n
    }
  ) {}

  async get(key: string): Promise<T | null>;
  async set(key: string, value: T): Promise<void>;
  getStats(): CacheStats; // Tasas de acierto, uso de memoria
}
```

```typescript {{ title: 'Procesamiento Concurrente' }}
// Procesamiento paralelo para mejor rendimiento
class NpmRegistryService {
  constructor(private readonly concurrency: number = 5) {}

  async getPackageInfo(names: string[]): Promise<PackageInfo[]> {
    // Procesar paquetes en lotes con concurrencia controlada
    const batches = chunk(names, this.concurrency);
    const results = await Promise.allSettled(batches.map((batch) => this.processBatch(batch)));

    return results.flatMap((result) => (result.status === 'fulfilled' ? result.value : []));
  }
}
```

</CodeGroup>
